<script type="text/javascript">
	$(function(){
		// **************** POSTPONE COURSE FROM SESSION ****************
		$(document).on('click', 'div.panel-heading div.row div.col-md-5 div.btn-group button.btn-primary', function(){
			// Hide/remove elements

			$(this).parent('div.btn-group').parent('div.col-md-5').parent('div.row').parent('div.panel-heading').parent('div.single-course').slideUp(400, function(){
				$(this).remove();
			});
		});
		// **************** IGNORE COURSE FROM SESSION ****************
		$(document).on('click', 'div.panel-heading div.row div.col-md-5 div.btn-group button.btn-danger', function(){
			$elem = $(this);
			// Mark course as ignored in the model
			$.post('/a.php?p=IgnoreCourse', {course_id: $('div.panel-heading input#course_id').val()}, function(d){
				if(!getAjaxStatus(d)){
					alert('Sorry, there was an error.');
				}else{
					// Hide/remove elements

					$elem.parent('div.btn-group').parent('div.col-md-5').parent('div.row').parent('div.panel-heading').parent('div.single-course').slideUp(400, function(){
						$(this).remove();
					});

				}
			});
			// Clear search box
			$("div#content div#classSearch input#classSearchField").val("");
			doneTyping();
		});
		// **************** ADD COURSE TO SESSION ****************
		$(document).on('click', 'div.panel-heading div.row div.col-md-5 div.btn-group button.btn-success', function(){
			$elem = $(this);
			//alert($('div.panel-heading input#course_id').val());
			// Mark course as ignored in the model
			$.post('/a.php?p=AddCourse', {course_id: $('div.panel-heading input#course_id').val()}, function(d){
				if(!getAjaxStatus(d)){
					alert('Sorry, there was an error.');
				}else{
					// Hide/remove elements
					$elem.parent('div.btn-group').parent('div.col-md-5').parent('div.row').parent('div.panel-heading').parent('div.single-course').slideUp(400, function(){
						$(this).remove();
					});

					// Add course to left-hand list of courses
					var id = $elem.siblings('input#course_id').val().trim();
					var number = $elem.parent('div.btn-group').parent('div.col-md-5').siblings('div.col-md-7').children('h3').children('span:first').text().trim();
					var name = $elem.parent('div.btn-group').parent('div.col-md-5').siblings('div.col-md-7').children('h3').children('span:last').text().trim();
					$("div#sidebar ul.list-group")
						.append('<li class="list-group-item" style="display: none;"><input type="hidden" id="course_id" value="'+id+'" />'+'<span class="badge XButton">X</span>'+'<span class="badge">'+number+'</span>'+name+'</li>');
					$("div#sidebar ul.list-group li.list-group-item:last").slideDown(400);
				}
			});
			// Clear search box
			$("div#content div#classSearch input#classSearchField").val("");
			doneTyping();
		});
		// **************** REMOVE COURSE FROM SESSION ****************
		$(document).on('click', 'div#sidebar ul.list-group li.list-group-item span.XButton', function(){
			$elem = $(this);
			// Mark course as ignored in the model
			$.post('/a.php?p=RemoveCourse', {course_id: $elem.siblings("input#course_id").val().trim()}, function(d){

				if(!getAjaxStatus(d)){
					alert('Sorry, there was an error.');
					//alert(d);
				}else{
					// Hide/remove elements
					$elem.parent('li.list-group-item').slideUp(400, function(){
						$(this).remove();
						//doneTyping(); // Rerun the search in case new options are now avaliable...
					});
				}
			});
		});
		// **************** SEARCH ****************
		//setup before functions
		var typingTimer;                //timer identifier
		var doneTypingInterval = 100;  //time in ms, 5 second for example
		var $input = $('input#classSearchField');

		//on keyup, start the countdown
		$input.on('keyup', function () {
			clearTimeout(typingTimer);
			typingTimer = setTimeout(doneTyping, doneTypingInterval);
		});

		//on keydown, clear the countdown 
		$input.on('keydown', function () {
		  clearTimeout(typingTimer);
		});

		//user is "finished typing," do something
		function doneTyping (){
			$.post('/a.php?p=Search', {q: $input.val()}, function(d){
				if(getAjaxStatus(d)){
					// Everything went well
					$("div#courseResultsArea").html(getAjaxData(d));
				}else{
					//alert(getAjaxFailureReason(d));
				}
			});
		}

		


		//*****************ADD tag count*****************//
		$(document).on('click', 'div.panel-bottom div.row div.col-md-11 div.btn-group button.btn-default', function(){


			var $course_id = $(this).parent('div.btn-group').parent('div.col-md-11').parent('div.row').parent('div.panel-bottom').siblings("div.panel-heading").children('input#course_id').val();
			var $tag_id = $(this).siblings('input#tag_id').val();
			var $tag_name = $(this).children(".tagName").html();
			var $tag_count = $(this).children(".tagCount").html();
			var $final_position = $(this).children(".tagCount");
			var $num = 1;//adding one vote here.
			//PERHAPS ALLOW TO RETRACT VOTE in the future by passing in -1, and deleting the initial entry in the table.

			$.post('/a.php?p=AddTag', {course_id: $course_id, tag_id: $tag_id, tag_name: $tag_name,num: $num} ,function(d) { 
				if(!getAjaxStatus(d)){//If you voted twice, error will be here.
					//alert('Sorry, you have already voted on this tag.');
				}else{
					$final_position.html(parseInt($tag_count)+1);
				}	
			});
		});
	});
</script>

<div class="col-md-5" id="sidebar">
	<ul class="list-group">
		{{#usersCourses}}
			<li class="list-group-item">
				<input type="hidden" id="course_id" value="{{id}}" />
				<span class="badge XButton">X</span>
				<!-- How to make this look better. Also, class should be unique no?
				<span class="badge">ADD TAG</span>-->
				
				

				{{name}}
				<span class="badge">{{number}}</span>
			</li>
		{{/usersCourses}}
	</ul>
</div> <!-- /Sidebar -->



<div class="col-md-7">
	<div class="container">
		<div id="content">
			<div class="input-group" id="classSearch">
				<input type="text" id="classSearchField" class="form-control" placeholder="Search for courses by typing part of the name or title" autocomplete="off">
				<span class="input-group-addon" style="cursor: pointer;">Search</span>
			</div>
			<!--<div class="panel panel-default" id="courseResultsArea">-->
				{{#allCourses}}
					<div class="single-course">
						<div class="panel-heading">
							<!-- perhaps move course_id one position up -->
							<input type="hidden" id="course_id" value="{{id}}" />
							<div class="row">
								<div class="col-md-7">
									<h3 class="panel-title"><span>{{number}}</span> <span>{{name}}</span></h3>
								</div>
								<div class="col-md-5">
									<div class="btn-group" role="group">
										<input type="hidden" id="course_id" value="{{id}}" />
										<button type="button" class="btn btn-success">Add</button>
										<button type="button" class="btn btn-primary">Postpone</button>
										<button type="button" class="btn btn-danger">Ignore</button>
									</div>
								</div>
							</div>
						</div>

						<div class="panel-body">
							<div class="row">{{description}}</div>
						</div>
						
						<div class="panel-bottom">
							
							<div class="row">
								<div class="col-md-11">
									{{#allTags}}

									<div class="btn-group" role="group">
										<input type="hidden" id="tag_id" value="{{tagId}}" />
										<button type="button" class="btn btn-default">
											<span class = "tagName">{{tagName}}</span> 
											
											<span class = "tagCount">{{count}}</span>
										</button>
									</div>
									{{/allTags}}
								</div>
							</div>
							
						</div>
						
					</div>
					<!-- needs spacing here-->
				{{/allCourses}}
			<!--</div>-->
		</div>
	</div>
</div> <!-- /col-md-7 -->